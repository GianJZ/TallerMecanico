generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum MovementType {
  IN
  OUT
  ADJUST
}

enum EstimateStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  CANCELED
}

model Product {
  id         String  @id @default(cuid())
  name       String
  sku        String? @unique
  barcode    String? @unique
  brand      String?
  category   String?
  location   String?
  unit       String?
  costPrice  Int?
  salePrice  Int?
  stock      Int     @default(0)
  minStock   Int     @default(0)
  usageCount Int     @default(0)
  isActive   Boolean @default(true)

  imageUrl String?
  imageAlt String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movements     Movement[]
  estimateItems EstimateItem[]

  @@index([name])
  @@index([barcode])
}

model Movement {
  id         String       @id @default(cuid())
  type       MovementType
  quantity   Int
  unitPrice  Int?
  note       String?
  happenedAt DateTime     @default(now())

  productId String
  product   Product @relation(fields: [productId], references: [id])

  estimateId String?
  estimate   Estimate? @relation(fields: [estimateId], references: [id])

  createdAt DateTime @default(now())

  @@index([happenedAt])
  @@index([type])
  @@index([productId, happenedAt])
}

model Customer {
  id      String  @id @default(cuid())
  name    String
  phone   String?
  email   String?
  address String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles  Vehicle[]
  estimates Estimate[]

  @@index([name])
  @@index([email])
}

model Vehicle {
  id    String  @id @default(cuid())
  plate String  @unique
  brand String?
  model String?
  year  Int?
  vin   String?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  estimates Estimate[]

  @@index([plate])
}

model Estimate {
  id     String         @id @default(cuid())
  folio  Int            @unique
  status EstimateStatus @default(DRAFT)

  // Datos manuales
  customerName  String
  customerPhone String
  customerEmail String?
  vehicleName   String
  vehicleYear   Int?

  // Relaciones (opcionales)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])
  vehicleId  String?
  vehicle    Vehicle?  @relation(fields: [vehicleId], references: [id])

  notes     String?
  laborCost Int     @default(0)
  discount  Int     @default(0)
  taxRate   Int     @default(19)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     EstimateItem[]
  movements Movement[]
}

model EstimateItem {
  id String @id @default(cuid())

  estimateId String
  estimate   Estimate @relation(fields: [estimateId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int
  unitPrice Int

  createdAt DateTime @default(now())

  @@index([estimateId])
  @@index([productId])
}

model Counter {
  key       String   @id
  value     Int      @default(0)
  updatedAt DateTime @updatedAt
}
